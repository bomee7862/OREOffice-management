import { useEffect, useState, useMemo } from 'react';
import { transactionsApi, billingsApi, dashboardApi } from '../api';
import { Transaction, Billing } from '../types';
import { format, startOfMonth, endOfMonth, eachMonthOfInterval, parseISO } from 'date-fns';
import { ko } from 'date-fns/locale';
import { 
  TrendingUp, TrendingDown, Search, Download, Calendar,
  ChevronDown, ChevronUp, BarChart3, Wallet, ArrowUpRight, ArrowDownRight,
  Building2, Mailbox
} from 'lucide-react';
import {
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
} from 'recharts';

// ìˆ˜ì… ì¹´í…Œê³ ë¦¬
const INCOME_CATEGORIES = [
  { value: 'ì›”ì‚¬ìš©ë£Œ', label: 'í˜¸ì‹¤ë³„ ì„ëŒ€ë£Œ' },
  { value: 'ë¹„ìƒì£¼ì‚¬ìš©ë£Œ', label: 'ë¹„ìƒì£¼ ì‚¬ìš©ë£Œ' },
  { value: 'ìœ„ì•½ê¸ˆ', label: 'ìœ„ì•½ê¸ˆ (ì¤‘ë„ì¢…ë£Œ)' },
  { value: 'ì‚¬ìš©ë£Œì „í™˜', label: 'ì‚¬ìš©ë£Œì „í™˜ (ë§Œê¸°ì¢…ë£Œ)' },
  { value: 'íšŒì˜ì‹¤ì‚¬ìš©ë£Œ', label: 'íšŒì˜ì‹¤ ì‚¬ìš©ë£Œ' },
  { value: '1dayì‚¬ìš©ë£Œ', label: '1day ì‚¬ìš©ë£Œ' },
];

// ì§€ì¶œ ì¹´í…Œê³ ë¦¬
const EXPENSE_CATEGORIES = [
  { value: 'ì„ëŒ€ë£Œ', label: 'ì‚¬ë¬´ì‹¤ ì„ëŒ€ë£Œ' },
  { value: 'ê´€ë¦¬ë¹„', label: 'ê´€ë¦¬ë¹„' },
  { value: 'ê³µê³¼ê¸ˆ', label: 'ê³µê³¼ê¸ˆ' },
  { value: 'ìˆ˜ì„ ìœ ì§€ë¹„', label: 'ìˆ˜ì„ ìœ ì§€ë¹„' },
  { value: 'ì†Œëª¨í’ˆë¹„', label: 'ì†Œëª¨í’ˆë¹„' },
  { value: 'ê¸°íƒ€', label: 'ê¸°íƒ€ ì§€ì¶œ' },
];

export default function Report() {
  // ê¸°ê°„ ì„¤ì •
  const [startDate, setStartDate] = useState(() => {
    const date = new Date();
    date.setMonth(date.getMonth() - 5);
    return format(startOfMonth(date), 'yyyy-MM-dd');
  });
  const [endDate, setEndDate] = useState(() => format(endOfMonth(new Date()), 'yyyy-MM-dd'));
  
  // ì¹´í…Œê³ ë¦¬ ì„ íƒ
  const [selectedIncomeCategories, setSelectedIncomeCategories] = useState<string[]>(
    INCOME_CATEGORIES.map(c => c.value)
  );
  const [selectedExpenseCategories, setSelectedExpenseCategories] = useState<string[]>(
    EXPENSE_CATEGORIES.map(c => c.value)
  );
  
  // ë°ì´í„°
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [billings, setBillings] = useState<Billing[]>([]);
  const [totalDepositHeld, setTotalDepositHeld] = useState(0);
  const [occupancyStats, setOccupancyStats] = useState({
    occupiedRooms: 0,
    totalRooms: 35,
    occupiedPostbox: 0,
    totalPostbox: 70
  });
  const [loading, setLoading] = useState(true);
  
  // í¼ì¹¨/ì ‘í˜ ìƒíƒœ
  const [showIncomeFilter, setShowIncomeFilter] = useState(false);
  const [showExpenseFilter, setShowExpenseFilter] = useState(false);

  // ì´ˆê¸° ë¡œë“œë§Œ ì‹¤í–‰ (ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ë°ì´í„° ê°±ì‹ )
  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setLoading(true);
    try {
      // ê¸°ê°„ ë‚´ ëª¨ë“  ì›”ì˜ billingsë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ì›” ëª©ë¡ ìƒì„±
      const start = parseISO(startDate);
      const end = parseISO(endDate);
      const months = eachMonthOfInterval({ start, end });
      
      const [transRes, dashboardRes, ...billingsRes] = await Promise.all([
        transactionsApi.getAll({
          start_date: startDate,
          end_date: endDate
        }),
        dashboardApi.getSummary(),
        ...months.map(month => billingsApi.getAll({ year_month: format(month, 'yyyy-MM') }))
      ]);
      
      setTransactions(transRes.data);
      setTotalDepositHeld(dashboardRes.data.total_deposit || 0);
      setOccupancyStats({
        occupiedRooms: dashboardRes.data.occupied_rooms || 0,
        totalRooms: dashboardRes.data.total_rooms || 35,
        occupiedPostbox: dashboardRes.data.occupied_postbox || 0,
        totalPostbox: dashboardRes.data.total_postbox || 70
      });
      
      // ëª¨ë“  ì›”ì˜ billingsë¥¼ í•©ì¹¨
      const allBillings = billingsRes.flatMap(res => res.data);
      setBillings(allBillings);
    } catch (error) {
      console.error('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
    } finally {
      setLoading(false);
    }
  };

  // í•„í„°ë§ëœ ê±°ë˜
  const filteredTransactions = useMemo(() => {
    return transactions.filter(t => {
      if (t.type === 'ì…ê¸ˆ') {
        return selectedIncomeCategories.includes(t.category);
      } else {
        return selectedExpenseCategories.includes(t.category);
      }
    });
  }, [transactions, selectedIncomeCategories, selectedExpenseCategories]);

  // í˜¸ì‹¤ë³„ ì„ëŒ€ë£Œ (billing ê¸°ì¤€)
  const billingIncome = useMemo(() => {
    if (!selectedIncomeCategories.includes('ì›”ì‚¬ìš©ë£Œ')) return 0;
    return billings
      .filter(b => b.status === 'ì™„ë£Œ')
      .reduce((sum, b) => sum + b.amount, 0);
  }, [billings, selectedIncomeCategories]);

  // ê¸°íƒ€ ìˆ˜ì… (transactions ê¸°ì¤€, ì›”ì‚¬ìš©ë£Œ ì œì™¸)
  const otherIncome = useMemo(() => {
    return filteredTransactions
      .filter(t => t.type === 'ì…ê¸ˆ' && t.status === 'ì™„ë£Œ' && t.category !== 'ì›”ì‚¬ìš©ë£Œ')
      .reduce((sum, t) => sum + t.amount, 0);
  }, [filteredTransactions]);

  // ì´ ìˆ˜ì… = í˜¸ì‹¤ë³„ ì„ëŒ€ë£Œ(billing) + ê¸°íƒ€ ìˆ˜ì…(transactions)
  const totalIncome = billingIncome + otherIncome;

  const totalExpense = useMemo(() => {
    return filteredTransactions
      .filter(t => t.type === 'ì§€ì¶œ')
      .reduce((sum, t) => sum + t.amount, 0);
  }, [filteredTransactions]);

  const netProfit = totalIncome - totalExpense;

  // ì˜ˆìˆ˜ê¸ˆ ë³€ë™ ê³„ì‚° (ì „ì²´ transactionsì—ì„œ - í•„í„°ì™€ ë¬´ê´€)
  const depositChanges = useMemo(() => {
    const newDeposits = transactions
      .filter(t => t.category === 'ë³´ì¦ê¸ˆì…ê¸ˆ')
      .reduce((sum, t) => sum + t.amount, 0);
    const newDepositsCount = transactions.filter(t => t.category === 'ë³´ì¦ê¸ˆì…ê¸ˆ').length;
    
    const penaltyConversion = transactions
      .filter(t => t.category === 'ìœ„ì•½ê¸ˆ')
      .reduce((sum, t) => sum + t.amount, 0);
    const penaltyCount = transactions.filter(t => t.category === 'ìœ„ì•½ê¸ˆ').length;
    
    const usageConversion = transactions
      .filter(t => t.category === 'ì‚¬ìš©ë£Œì „í™˜')
      .reduce((sum, t) => sum + t.amount, 0);
    const usageCount = transactions.filter(t => t.category === 'ì‚¬ìš©ë£Œì „í™˜').length;
    
    const netChange = newDeposits - penaltyConversion - usageConversion;
    
    return {
      newDeposits,
      newDepositsCount,
      penaltyConversion,
      penaltyCount,
      usageConversion,
      usageCount,
      netChange
    };
  }, [transactions]);

  // ì›”ë³„ ë°ì´í„° (ì°¨íŠ¸ìš©)
  const monthlyData = useMemo(() => {
    if (!startDate || !endDate) return [];
    
    const start = parseISO(startDate);
    const end = parseISO(endDate);
    const months = eachMonthOfInterval({ start, end });
    
    return months.map(month => {
      const monthStr = format(month, 'yyyy-MM');
      const monthLabel = format(month, 'Mì›”', { locale: ko });
      
      const monthTransactions = filteredTransactions.filter(t => {
        const tDate = t.transaction_date.substring(0, 7);
        return tDate === monthStr;
      });
      
      // ì „ì²´ transactionsì—ì„œ ì˜ˆìˆ˜ê¸ˆ ê´€ë ¨ (í•„í„°ì™€ ë¬´ê´€)
      const allMonthTransactions = transactions.filter(t => {
        const tDate = t.transaction_date.substring(0, 7);
        return tDate === monthStr;
      });
      
      // í•´ë‹¹ ì›”ì˜ billings (ì™„ë£Œëœ ê²ƒë§Œ)
      const monthBillings = billings.filter(b => 
        b.year_month === monthStr && b.status === 'ì™„ë£Œ'
      );
      
      // í˜¸ì‹¤ë³„ ì„ëŒ€ë£Œ (billing ê¸°ì¤€)
      const billingAmount = selectedIncomeCategories.includes('ì›”ì‚¬ìš©ë£Œ')
        ? monthBillings.reduce((sum, b) => sum + b.amount, 0)
        : 0;
      
      // ê¸°íƒ€ ìˆ˜ì… (transactions ê¸°ì¤€, ì›”ì‚¬ìš©ë£Œ ì œì™¸)
      const otherIncomeAmount = monthTransactions
        .filter(t => t.type === 'ì…ê¸ˆ' && t.status === 'ì™„ë£Œ' && t.category !== 'ì›”ì‚¬ìš©ë£Œ')
        .reduce((sum, t) => sum + t.amount, 0);
      
      const income = billingAmount + otherIncomeAmount;
      
      const expense = monthTransactions
        .filter(t => t.type === 'ì§€ì¶œ')
        .reduce((sum, t) => sum + t.amount, 0);
      
      // ì˜ˆìˆ˜ê¸ˆ (ì‹ ê·œ ì…ê¸ˆ)
      const newDeposit = allMonthTransactions
        .filter(t => t.category === 'ë³´ì¦ê¸ˆì…ê¸ˆ')
        .reduce((sum, t) => sum + t.amount, 0);
      
      return {
        month: monthLabel,
        ì§€ì¶œ: expense,
        ìˆ˜ì…: income,
        ì˜ˆìˆ˜ê¸ˆ: newDeposit,
        ì†ìµ: income - expense
      };
    });
  }, [filteredTransactions, transactions, billings, selectedIncomeCategories, startDate, endDate]);

  // ì¹´í…Œê³ ë¦¬ë³„ í•©ê³„ (í…Œì´ë¸”ìš©)
  const categoryTotals = useMemo(() => {
    const incomeByCategory: { [key: string]: number } = {};
    const expenseByCategory: { [key: string]: number } = {};
    
    // í˜¸ì‹¤ë³„ ì„ëŒ€ë£ŒëŠ” billing ê¸°ì¤€
    incomeByCategory['ì›”ì‚¬ìš©ë£Œ'] = billings
      .filter(b => b.status === 'ì™„ë£Œ')
      .reduce((sum, b) => sum + b.amount, 0);
    
    // ê¸°íƒ€ ìˆ˜ì…ì€ transactions ê¸°ì¤€ (ì›”ì‚¬ìš©ë£Œ ì œì™¸)
    filteredTransactions.forEach(t => {
      if (t.type === 'ì…ê¸ˆ' && t.status === 'ì™„ë£Œ' && t.category !== 'ì›”ì‚¬ìš©ë£Œ') {
        incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + t.amount;
      } else if (t.type === 'ì§€ì¶œ') {
        expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
      }
    });
    
    return { incomeByCategory, expenseByCategory };
  }, [filteredTransactions, billings]);

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
  };

  // ì „ì²´ ì„ íƒ/í•´ì œ
  const toggleAllIncome = () => {
    if (selectedIncomeCategories.length === INCOME_CATEGORIES.length) {
      setSelectedIncomeCategories([]);
    } else {
      setSelectedIncomeCategories(INCOME_CATEGORIES.map(c => c.value));
    }
  };

  const toggleAllExpense = () => {
    if (selectedExpenseCategories.length === EXPENSE_CATEGORIES.length) {
      setSelectedExpenseCategories([]);
    } else {
      setSelectedExpenseCategories(EXPENSE_CATEGORIES.map(c => c.value));
    }
  };

  // CSV ë‹¤ìš´ë¡œë“œ
  const exportCSV = () => {
    const headers = ['ì›”', 'ì§€ì¶œ', 'ìˆ˜ì…', 'ì˜ˆìˆ˜ê¸ˆ', 'ì†ìµ'];
    const rows = monthlyData.map(d => [
      d.month,
      d.ì§€ì¶œ,
      d.ìˆ˜ì…,
      d.ì˜ˆìˆ˜ê¸ˆ,
      d.ì†ìµ
    ]);
    
    const csvContent = [
      headers.join(','),
      ...rows.map(r => r.join(','))
    ].join('\n');
    
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `ê¸°ê°„ë³„ì†ìµ_${startDate}_${endDate}.csv`;
    link.click();
    URL.revokeObjectURL(url);
  };

  // ì»¤ìŠ¤í…€ íˆ´íŒ
  const CustomTooltip = ({ active, payload, label }: any) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white p-3 rounded-xl shadow-lg border border-slate-200">
          <p className="font-semibold text-slate-900 mb-2">{label}</p>
          {payload.map((entry: any, index: number) => (
            <p key={index} className="text-sm" style={{ color: entry.color }}>
              {entry.name}: {formatCurrency(entry.value)}
            </p>
          ))}
        </div>
      );
    }
    return null;
  };

  return (
    <div className="space-y-6">
      {/* í—¤ë” */}
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-slate-900">ğŸ“Š ê¸°ê°„ë³„ ì†ìµ</h1>
        <button
          onClick={exportCSV}
          className="btn btn-secondary flex items-center gap-2"
        >
          <Download className="w-4 h-4" />
          CSV ë‹¤ìš´ë¡œë“œ
        </button>
      </div>

      {/* í•„í„° ì˜ì—­ */}
      <div className="card p-6 space-y-4">
        {/* ê¸°ê°„ ì„¤ì • */}
        <div className="flex flex-wrap items-center gap-4">
          <div className="flex items-center gap-2">
            <Calendar className="w-5 h-5 text-slate-500" />
            <span className="font-medium text-slate-700">ê¸°ê°„</span>
          </div>
          <input
            type="date"
            value={startDate}
            onChange={(e) => setStartDate(e.target.value)}
            className="input w-40"
          />
          <span className="text-slate-500">~</span>
          <input
            type="date"
            value={endDate}
            onChange={(e) => setEndDate(e.target.value)}
            className="input w-40"
          />
          <button onClick={loadData} className="btn btn-primary flex items-center gap-2">
            <Search className="w-4 h-4" />
            ì¡°íšŒ
          </button>
        </div>

        {/* ìˆ˜ì… í•­ëª© ì„ íƒ */}
        <div className="border-t border-slate-200 pt-4">
          <button
            onClick={() => setShowIncomeFilter(!showIncomeFilter)}
            className="flex items-center gap-2 text-green-700 font-medium hover:text-green-800"
          >
            <TrendingUp className="w-4 h-4" />
            ìˆ˜ì… í•­ëª©
            {showIncomeFilter ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
            <span className="text-sm text-slate-500 ml-2">
              ({selectedIncomeCategories.length}/{INCOME_CATEGORIES.length} ì„ íƒ)
            </span>
          </button>
          
          {showIncomeFilter && (
            <div className="mt-3 flex flex-wrap gap-2">
              <button
                onClick={toggleAllIncome}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                  selectedIncomeCategories.length === INCOME_CATEGORIES.length
                    ? 'bg-green-600 text-white'
                    : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
                }`}
              >
                ì „ì²´
              </button>
              {INCOME_CATEGORIES.map(cat => (
                <button
                  key={cat.value}
                  onClick={() => {
                    if (selectedIncomeCategories.includes(cat.value)) {
                      setSelectedIncomeCategories(prev => prev.filter(c => c !== cat.value));
                    } else {
                      setSelectedIncomeCategories(prev => [...prev, cat.value]);
                    }
                  }}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                    selectedIncomeCategories.includes(cat.value)
                      ? 'bg-green-100 text-green-700 border border-green-300'
                      : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                  }`}
                >
                  {cat.label}
                </button>
              ))}
            </div>
          )}
        </div>

        {/* ì§€ì¶œ í•­ëª© ì„ íƒ */}
        <div className="border-t border-slate-200 pt-4">
          <button
            onClick={() => setShowExpenseFilter(!showExpenseFilter)}
            className="flex items-center gap-2 text-red-700 font-medium hover:text-red-800"
          >
            <TrendingDown className="w-4 h-4" />
            ì§€ì¶œ í•­ëª©
            {showExpenseFilter ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
            <span className="text-sm text-slate-500 ml-2">
              ({selectedExpenseCategories.length}/{EXPENSE_CATEGORIES.length} ì„ íƒ)
            </span>
          </button>
          
          {showExpenseFilter && (
            <div className="mt-3 flex flex-wrap gap-2">
              <button
                onClick={toggleAllExpense}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                  selectedExpenseCategories.length === EXPENSE_CATEGORIES.length
                    ? 'bg-red-600 text-white'
                    : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
                }`}
              >
                ì „ì²´
              </button>
              {EXPENSE_CATEGORIES.map(cat => (
                <button
                  key={cat.value}
                  onClick={() => {
                    if (selectedExpenseCategories.includes(cat.value)) {
                      setSelectedExpenseCategories(prev => prev.filter(c => c !== cat.value));
                    } else {
                      setSelectedExpenseCategories(prev => [...prev, cat.value]);
                    }
                  }}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                    selectedExpenseCategories.includes(cat.value)
                      ? 'bg-red-100 text-red-700 border border-red-300'
                      : 'bg-slate-100 text-slate-500 hover:bg-slate-200'
                  }`}
                >
                  {cat.label}
                </button>
              ))}
            </div>
          )}
        </div>
      </div>

      {loading ? (
        <div className="flex items-center justify-center h-64">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
      ) : (
        <>
          {/* ìš”ì•½ ì¹´ë“œ */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="card p-6 bg-green-50 border-green-200">
              <div className="flex items-center gap-3">
                <div className="p-3 bg-green-100 rounded-xl">
                  <TrendingUp className="w-6 h-6 text-green-600" />
                </div>
                <div>
                  <p className="text-sm text-green-600 font-medium">ì´ ìˆ˜ì…</p>
                  <p className="text-2xl font-bold text-green-700">{formatCurrency(totalIncome)}</p>
                </div>
              </div>
            </div>

            <div className="card p-6 bg-red-50 border-red-200">
              <div className="flex items-center gap-3">
                <div className="p-3 bg-red-100 rounded-xl">
                  <TrendingDown className="w-6 h-6 text-red-600" />
                </div>
                <div>
                  <p className="text-sm text-red-600 font-medium">ì´ ì§€ì¶œ</p>
                  <p className="text-2xl font-bold text-red-700">{formatCurrency(totalExpense)}</p>
                </div>
              </div>
            </div>

            <div className="card p-6" style={{ 
              backgroundColor: netProfit >= 0 ? '#f0fdf4' : '#fef2f2',
              borderColor: netProfit >= 0 ? '#86efac' : '#fecaca'
            }}>
              <div className="flex items-center gap-3">
                <div className="p-3 rounded-xl" style={{ 
                  backgroundColor: netProfit >= 0 ? '#dcfce7' : '#fee2e2' 
                }}>
                  <BarChart3 className="w-6 h-6" style={{ 
                    color: netProfit >= 0 ? '#16a34a' : '#dc2626' 
                  }} />
                </div>
                <div>
                  <p className="text-sm font-medium" style={{ 
                    color: netProfit >= 0 ? '#16a34a' : '#dc2626' 
                  }}>ìˆœì´ìµ</p>
                  <p className="text-2xl font-bold" style={{ 
                    color: netProfit >= 0 ? '#15803d' : '#b91c1c' 
                  }}>{formatCurrency(netProfit)}</p>
                </div>
              </div>
            </div>

            <div className="card p-6 bg-purple-50 border-purple-200">
              <div className="flex items-center gap-3">
                <div className="p-3 bg-purple-100 rounded-xl">
                  <Wallet className="w-6 h-6 text-purple-600" />
                </div>
                <div>
                  <p className="text-sm text-purple-600 font-medium">ì˜ˆìˆ˜ê¸ˆ ì”ì•¡</p>
                  <p className="text-2xl font-bold text-purple-700">{formatCurrency(totalDepositHeld)}</p>
                  <p className="text-xs text-purple-500">í˜„ì¬ ë³´ìœ  ê¸°ì¤€</p>
                </div>
              </div>
            </div>

          </div>

          {/* ì˜ˆìˆ˜ê¸ˆ ë³€ë™ + ì…ì£¼í˜„í™© ì„¹ì…˜ */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* ì˜ˆìˆ˜ê¸ˆ ë³€ë™ (ì™¼ìª½ 2/3) */}
            <div className="lg:col-span-2 card p-5">
              <h3 className="text-base font-bold text-slate-900 mb-3 flex items-center gap-2">
                <Wallet className="w-4 h-4 text-purple-600" />
                ğŸ’° ì˜ˆìˆ˜ê¸ˆ ë³€ë™ (ì¡°íšŒ ê¸°ê°„)
              </h3>
              <div className="grid grid-cols-3 gap-3">
                <div className="p-3 bg-purple-50 rounded-xl">
                  <div className="flex items-center gap-1 mb-1">
                    <ArrowUpRight className="w-3 h-3 text-purple-600" />
                    <span className="text-xs text-purple-600 font-medium">ì‹ ê·œ ì…ê¸ˆ</span>
                  </div>
                  <p className="text-lg font-bold text-purple-700">+{formatCurrency(depositChanges.newDeposits)}</p>
                  <p className="text-xs text-purple-500">{depositChanges.newDepositsCount}ê±´</p>
                </div>
                
                <div className="p-3 bg-orange-50 rounded-xl">
                  <div className="flex items-center gap-1 mb-1">
                    <ArrowDownRight className="w-3 h-3 text-orange-600" />
                    <span className="text-xs text-orange-600 font-medium">ìœ„ì•½ê¸ˆ ì „í™˜</span>
                  </div>
                  <p className="text-lg font-bold text-orange-700">-{formatCurrency(depositChanges.penaltyConversion)}</p>
                  <p className="text-xs text-orange-500">{depositChanges.penaltyCount}ê±´</p>
                </div>
                
                <div className="p-3 bg-teal-50 rounded-xl">
                  <div className="flex items-center gap-1 mb-1">
                    <ArrowDownRight className="w-3 h-3 text-teal-600" />
                    <span className="text-xs text-teal-600 font-medium">ì‚¬ìš©ë£Œ ì „í™˜</span>
                  </div>
                  <p className="text-lg font-bold text-teal-700">-{formatCurrency(depositChanges.usageConversion)}</p>
                  <p className="text-xs text-teal-500">{depositChanges.usageCount}ê±´</p>
                </div>
              </div>
            </div>

            {/* ì…ì£¼í˜„í™© (ì˜¤ë¥¸ìª½ 1/3) */}
            <div className="card p-5">
              <h3 className="text-base font-bold text-slate-900 mb-3 flex items-center gap-2">
                <Building2 className="w-4 h-4 text-amber-600" />
                ğŸ¢ ì…ì£¼í˜„í™©
              </h3>
              <div className="space-y-3">
                <div className="p-3 bg-amber-50 rounded-xl">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <Building2 className="w-4 h-4 text-amber-600" />
                      <span className="text-sm text-amber-700 font-medium">í˜¸ì‹¤</span>
                    </div>
                    <span className="text-lg font-bold text-amber-700">
                      {((occupancyStats.occupiedRooms / occupancyStats.totalRooms) * 100).toFixed(0)}%
                    </span>
                  </div>
                  <p className="text-xs text-amber-500 mt-1 text-right">
                    {occupancyStats.occupiedRooms} / {occupancyStats.totalRooms} í˜¸ì‹¤
                  </p>
                </div>
                
                <div className="p-3 bg-violet-50 rounded-xl">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <Mailbox className="w-4 h-4 text-violet-600" />
                      <span className="text-sm text-violet-700 font-medium">ë¹„ìƒì£¼</span>
                    </div>
                    <span className="text-lg font-bold text-violet-700">
                      {((occupancyStats.occupiedPostbox / occupancyStats.totalPostbox) * 100).toFixed(0)}%
                    </span>
                  </div>
                  <p className="text-xs text-violet-500 mt-1 text-right">
                    {occupancyStats.occupiedPostbox} / {occupancyStats.totalPostbox} POST BOX
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* ì›”ë³„ ë¼ì¸ ì°¨íŠ¸ */}
          <div className="card p-6">
            <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
              <BarChart3 className="w-5 h-5 text-blue-600" />
              ì›”ë³„ ì¶”ì´
            </h3>
            <div className="h-80">
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={monthlyData} margin={{ top: 5, right: 30, left: 10, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                  <XAxis 
                    dataKey="month" 
                    stroke="#64748b"
                    fontSize={12}
                  />
                  <YAxis 
                    stroke="#64748b"
                    fontSize={11}
                    width={60}
                    tickFormatter={(value) => {
                      const absValue = Math.abs(value);
                      if (absValue >= 100000000) {
                        return `${(value / 100000000).toFixed(1)}ì–µ`;
                      }
                      return `${Math.round(value / 10000)}ë§Œ`;
                    }}
                  />
                  <Tooltip content={<CustomTooltip />} />
                  <Legend />
                  <Line 
                    type="monotone" 
                    dataKey="ì§€ì¶œ" 
                    stroke="#ef4444" 
                    strokeWidth={2}
                    dot={{ fill: '#ef4444', strokeWidth: 2, r: 4 }}
                    activeDot={{ r: 6 }}
                  />
                  <Line 
                    type="monotone" 
                    dataKey="ìˆ˜ì…" 
                    stroke="#22c55e" 
                    strokeWidth={2}
                    dot={{ fill: '#22c55e', strokeWidth: 2, r: 4 }}
                    activeDot={{ r: 6 }}
                  />
                  <Line 
                    type="monotone" 
                    dataKey="ì˜ˆìˆ˜ê¸ˆ" 
                    stroke="#a855f7" 
                    strokeWidth={2}
                    dot={{ fill: '#a855f7', strokeWidth: 2, r: 4 }}
                    activeDot={{ r: 6 }}
                  />
                  <Line 
                    type="monotone" 
                    dataKey="ì†ìµ" 
                    stroke="#3b82f6" 
                    strokeWidth={2}
                    strokeDasharray="5 5"
                    dot={{ fill: '#3b82f6', strokeWidth: 2, r: 4 }}
                    activeDot={{ r: 6 }}
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* ìƒì„¸ í…Œì´ë¸” */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* ìˆ˜ì… ìƒì„¸ */}
            <div className="card">
              <div className="p-4 border-b border-slate-200 bg-green-50">
                <h3 className="font-semibold text-slate-900 flex items-center gap-2">
                  <TrendingUp className="w-5 h-5 text-green-600" />
                  ìˆ˜ì… ìƒì„¸
                </h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-slate-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-sm font-medium text-slate-500">í•­ëª©</th>
                      <th className="px-4 py-3 text-right text-sm font-medium text-slate-500">ê¸ˆì•¡</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {INCOME_CATEGORIES
                      .filter(cat => selectedIncomeCategories.includes(cat.value))
                      .map(cat => {
                        const amount = categoryTotals.incomeByCategory[cat.value] || 0;
                        return (
                          <tr key={cat.value} className={amount === 0 ? 'text-slate-400' : ''}>
                            <td className="px-4 py-3 text-sm">{cat.label}</td>
                            <td className="px-4 py-3 text-sm text-right font-medium text-green-600">
                              {formatCurrency(amount)}
                            </td>
                          </tr>
                        );
                      })}
                    <tr className="bg-green-50 font-bold">
                      <td className="px-4 py-3">í•©ê³„</td>
                      <td className="px-4 py-3 text-right text-green-700">{formatCurrency(totalIncome)}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            {/* ì§€ì¶œ ìƒì„¸ */}
            <div className="card">
              <div className="p-4 border-b border-slate-200 bg-red-50">
                <h3 className="font-semibold text-slate-900 flex items-center gap-2">
                  <TrendingDown className="w-5 h-5 text-red-600" />
                  ì§€ì¶œ ìƒì„¸
                </h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-slate-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-sm font-medium text-slate-500">í•­ëª©</th>
                      <th className="px-4 py-3 text-right text-sm font-medium text-slate-500">ê¸ˆì•¡</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100">
                    {EXPENSE_CATEGORIES
                      .filter(cat => selectedExpenseCategories.includes(cat.value))
                      .map(cat => {
                        const amount = categoryTotals.expenseByCategory[cat.value] || 0;
                        return (
                          <tr key={cat.value} className={amount === 0 ? 'text-slate-400' : ''}>
                            <td className="px-4 py-3 text-sm">{cat.label}</td>
                            <td className="px-4 py-3 text-sm text-right font-medium text-red-600">
                              {formatCurrency(amount)}
                            </td>
                          </tr>
                        );
                      })}
                    <tr className="bg-red-50 font-bold">
                      <td className="px-4 py-3">í•©ê³„</td>
                      <td className="px-4 py-3 text-right text-red-700">{formatCurrency(totalExpense)}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          {/* ì›”ë³„ ìƒì„¸ í…Œì´ë¸” */}
          <div className="card">
            <div className="p-4 border-b border-slate-200">
              <h3 className="font-semibold text-slate-900 flex items-center gap-2">
                <Calendar className="w-5 h-5 text-blue-600" />
                ì›”ë³„ ìƒì„¸
              </h3>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-slate-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-slate-500">ì›”</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-slate-500">ì§€ì¶œ</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-slate-500">ìˆ˜ì…</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-slate-500">ì˜ˆìˆ˜ê¸ˆ</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-slate-500">ì†ìµ</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-100">
                  {monthlyData.map((data, idx) => (
                    <tr key={idx} className="hover:bg-slate-50">
                      <td className="px-4 py-3 text-sm font-medium text-slate-900">{data.month}</td>
                      <td className="px-4 py-3 text-sm text-right text-red-600 font-medium">
                        {formatCurrency(data.ì§€ì¶œ)}
                      </td>
                      <td className="px-4 py-3 text-sm text-right text-green-600 font-medium">
                        {formatCurrency(data.ìˆ˜ì…)}
                      </td>
                      <td className="px-4 py-3 text-sm text-right text-purple-600 font-medium">
                        {formatCurrency(data.ì˜ˆìˆ˜ê¸ˆ)}
                      </td>
                      <td className={`px-4 py-3 text-sm text-right font-bold ${
                        data.ì†ìµ >= 0 ? 'text-blue-600' : 'text-red-600'
                      }`}>
                        {formatCurrency(data.ì†ìµ)}
                      </td>
                    </tr>
                  ))}
                  <tr className="bg-slate-100 font-bold">
                    <td className="px-4 py-3">í•©ê³„</td>
                    <td className="px-4 py-3 text-right text-red-700">{formatCurrency(totalExpense)}</td>
                    <td className="px-4 py-3 text-right text-green-700">{formatCurrency(totalIncome)}</td>
                    <td className="px-4 py-3 text-right text-purple-700">{formatCurrency(depositChanges.newDeposits)}</td>
                    <td className={`px-4 py-3 text-right ${netProfit >= 0 ? 'text-blue-700' : 'text-red-700'}`}>
                      {formatCurrency(netProfit)}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </>
      )}
    </div>
  );
}
